worker_processes 1;

events {
    worker_connections 1024;
}

http {
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";

    server {
        listen 80;
        server_name _;

        # =======================================
        # Jenkins 1
        # =======================================
        location /webhook1 {
            set $jenkins_url "http://jenkins1.internal/github-webhook/";
            content_by_lua_file /usr/local/openresty/nginx/lua/validate.lua;
        }

        # =======================================
        # Jenkins 2
        # =======================================
        location /webhook2 {
            set $jenkins_url "http://jenkins2.internal/github-webhook/";
            content_by_lua_file /usr/local/openresty/nginx/lua/validate.lua;
        }

        # =======================================
        # Jenkins 3
        # =======================================
        location /webhook3 {
            set $jenkins_url "http://jenkins3.internal/github-webhook/";
            content_by_lua_file /usr/local/openresty/nginx/lua/validate.lua;
        }

        # =======================================
        # Internal proxy (generic for all Jenkins)
        # =======================================
        location /proxy_to_jenkins {
            internal;                           # Only accessible from Lua
            proxy_pass $jenkins_url;             # Uses Jenkins URL set in the caller
            proxy_set_header Content-Type "application/json";
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
        }
    }
}
